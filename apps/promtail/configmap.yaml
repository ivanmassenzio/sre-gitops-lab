apiVersion: v1
kind: ConfigMap
metadata:
  name: promtail-config
  namespace: monitoring
data:
  promtail.yaml: |
    server:
      http_listen_port: 9080
      grpc_listen_port: 0

    positions:
      filename: /tmp/positions.yaml

    clients:
      - url: http://observability-loki:3100/loki/api/v1/push

    scrape_configs:
    # MODO NUCLEAR MEJORADO
    # 1. Busca todo lo que termine en .log dentro de pods
    # 2. Usa Regex para extraer Namespace, Pod y Contenedor del nombre de la carpeta
    - job_name: system-logs
      static_configs:
      - targets:
        - localhost
        labels:
          job: varlogs
          __path__: /var/log/pods/*/*/*.log
      
      pipeline_stages:
      # Parseamos la ruta: /var/log/pods/NAMESPACE_POD_UID/CONTAINER/archivo.log
      - regex:
          source: filename
          expression: "^/var/log/pods/(?P<namespace>[^_]+)_(?P<pod>.+)_(?P<uid>[a-f0-9\\-]+)/(?P<container>[^/]+)/.*$"
      
      # Convertimos lo extra√≠do en etiquetas reales de Loki
      - labels:
          namespace:
          pod:
          container: